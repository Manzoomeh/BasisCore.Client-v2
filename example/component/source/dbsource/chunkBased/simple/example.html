<!DOCTYPE html>
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <script src="http://localhost:3000/basiscore.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pako@2/dist/pako.min.js"></script>

    <title>lachin sample</title>
    <style>
      body {
        font-family: "Arial", sans-serif;
        line-height: 1.6;
        margin: 0;
        padding: 0;
        background-color: #f5f5f5;
        color: #333;
      }
      tr:nth-child(even) {
        background-color: #dddddd50;
      }
      .container {
        max-width: 8000px;
        margin: 20px auto;
        background-color: #fff;
        padding: 20px;
        border: 1px solid #ccc;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      fieldset {
        border: 1px solid #ccc;
        padding: 10px;
        margin-bottom: 20px;
      }

      legend {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        margin-bottom: 20px;
      }

      table,
      th,
      td {
        border: 1px solid #ccc;
      }

      th,
      td {
        padding: 8px;
        text-align: left;
      }

      th {
        background-color: #f2f2f2;
      }

      .result {
        margin-top: 20px;
        max-width: 8000px;
        padding: 20px;
        background-color: #fff;
        border: 1px solid #ccc;
        box-shadow: 0 0 10px rgba(0, 0, 0, 0.1);
      }

      .result legend {
        font-size: 1.2em;
        font-weight: bold;
        color: #333;
      }

      .result table {
        width: 100%;
        border-collapse: collapse;
      }

      .result th,
      .result td {
        border: 1px solid #ccc;
        padding: 8px;
        text-align: left;
      }

      .result th {
        background-color: #f2f2f2;
      }

      .result td p {
        margin: 0;
      }
    </style>
  </head>

  <body>
    <basis
      core="dbsource"
      source="simple"
      name="flight"
      run="atclient"
      OnProcessing="changeStructure"
    >
      <member name="list" />
    </basis>
    <fieldset>
      <legend>find</legend>
      <label
        >Destination:
        <input name="demo.filter-Destination" bc-triggers="keyup change"
      /></label>
      <label
        >min Price:
        <input name="demo.filter-minPrice" bc-triggers="keyup change"
      /></label>
      <label
        >max Price:
        <input name="demo.filter-maxPrice" bc-triggers="keyup change"
      /></label>
      <br />
    </fieldset>
    <div class="container">
      <Basis
        core="print"
        datamembername="db.origin"
        run="atclient"
        triggers="demo.sort-by demo.filter "
      >
        <layout>
          <script type="text/template">
            companies :
            <form action="/action_page.php">
                @child
            </form>
          </script>
        </layout>
        <face>
          <script type="text/template">
            <input id="@Origin@" type="checkbox" name="demo.filter" bc-value="@Origin@" onclick="findByCompany('@Origin@')" />
            <label for="@Origin@">@Origin@</label> <br/>
          </script>
        </face>
      </Basis>
      <Basis
        core="print"
        datamembername="db.timeZone"
        run="atclient"
        triggers="demo.sort-by demo.filter-id demo.filter-name demo.filter-age"
      >
        <layout>
          <script type="text/template">
            time zones :
            <form action="/action_page.php">
                @child
            </form>
          </script>
        </layout>
        <face>
          <script type="text/template">
            <input id="@zone@" type="checkbox" name="demo.filter" bc-value="@zone@" onclick="findByTimeZone('@zone@')" />
            <label for="@zone@">@zone@</label> <br/>
          </script>
        </face>
      </Basis>
      <Basis
        core="print"
        datamembername="db.minPrice"
        run="atclient"
        triggers="demo.sort-by demo.filter-id demo.filter-name demo.filter-age demo.filter-maxPrice demo.filter-minPrice"
      >
        <layout>
          <script type="text/template">
            <table>
                <thead>

                    <tr>
                        <td name="demo.sort-by" bc-triggers="click" bc-value="Id">MIN PRICES</td>
                    </tr>
                </thead>
                <tbody>@child</tbody>
                <tfoot></tfoot>
            </table>
          </script>
        </layout>
        <face>
          <script type="text/template">
            <tr>
                <td name= "demo.filter" onclick="findByCompany('@Origin@')">@Origin@</td>
                <td>@Price@</td>
            </tr>
          </script>
        </face>
      </Basis>
    </div>
    <div class="result">
      <fieldset>
        <legend>Result</legend>
        <Basis
          core="print"
          datamembername="flight.list"
          run="atclient"
          OnProcessing="manipulation"
          triggers="demo.sort-by demo.filter-id demo.filter-name demo.filter-age"
        >
          <layout>
            <script type="text/template">
              <table>
                  <thead>

                      <tr>
                          <td name="demo.sort-by" bc-triggers="click" bc-value="Id">Id</td>
                          <td name="demo.sort-by" bc-triggers="click" bc-value="ArrivalDate">ArrivalDate</td>
                          <td name="demo.sort-by" bc-triggers="click" bc-value="ArrivalTime">ArrivalTime</td>
                          <td name="demo.sort-by" bc-triggers="click" bc-value="AvailableSeats">AvailableSeats</td>
                          <td name="demo.sort-by" bc-triggers="click" bc-value="Baggages">Baggages</td>
                          <td name="demo.sort-by" bc-triggers="click" bc-value="Class">Class</td>
                          <td name="demo.sort-by" bc-triggers="click" bc-value="DepartureDate">DepartureTime</td>
                          <td name="demo.sort-by" bc-triggers="click" bc-value="TotalPrice">TotalPrice</td>
                          <td name="demo.sort-by" bc-triggers="click" bc-value="Currency">Currency</td>
                          <td name="demo.sort-by" bc-triggers="click" bc-value="DepartureDate">DepartureDate</td>
                          <td name="demo.sort-by" bc-triggers="click" bc-value="Destination">Destination</td>
                          <td name="demo.sort-by" bc-triggers="click" bc-value="Duration">Duration</td>
                          <td name="demo.sort-by" bc-triggers="click" bc-value="NumberOfStops">NumberOfStops</td>
                          <td name="demo.sort-by" bc-triggers="click" bc-value="Origin">Origin</td>
                          <td name="demo.sort-by" bc-triggers="click" bc-value="isSystemFlight">isSystemFlight</td>
                          <td name="demo.sort-by" bc-triggers="click" bc-value="PriceInfo">PriceInfo</td>
                          <td name="demo.sort-by" bc-triggers="click" bc-value="Baggages"> Baggages</td>
                      </tr>
                  </thead>
                  <tbody>@child</tbody>
                  <tfoot></tfoot>
              </table>
            </script>
          </layout>
          <face>
            <script type="text/template">
              <tr>
                  <td>@ID@</td>
                  <td>@ArrivalDate@</td>
                  <td>@ArrivalTime@</td>
                  <td>@AvailableSeats@</td>
                  <td>@Baggages@</td>
                  <td>@Class@</td>
                  <td>@DepartureTime@</td>
                  <td>@TotalPrice@</td>
                  <td>@Currency@</td>
                  <td>@DepartureDate@</td>
                  <td>@Destination@</td>
                  <td>@Duration@</td>
                  <td>@NumberOfStops@</td>
                  <td>@Origin@</td>
                  <td>@isSystemFlight@</td>
                  <td>@PriceInfo@</td>
                  <td>@Baggages@</td>
              </tr>
            </script>
          </face>
        </Basis>
      </fieldset>
    </div>

    <script>
      function getDicToHtml(array) {
        let retVal = "";
        array.forEach((element) => {
          for (let key in element) {
            if (element[key]) {
              retVal += `<p> ${key} : ${element[key]} </p>
                        `;
            }
            retVal += `..........................................
                    `;
          }
        });
        return retVal;
      }
      let companyNames = [];
      let timeZones = [];
      var host = {
        dbLibPath: "https://cdn.basiscore.net/_js/alasql.min.js",
        settings: {
          "connection.chunkBased.simple": {"Connection":"http://localhost:3000/chunk/chunk-no-final-value","gzipMode":"perchunk" , "method" :"GET"},
          "default.dmnid": 2668,
        },
      };
      function findTime(time) {
        let number = Number(time.split(":")[0]);
        return number >= 6 && number <= 12
          ? "Day"
          : number > 12 && number <= 18
          ? "Noon"
          : number > 18 && number >= 23
          ? "Night"
          : "midNight";
      }
      let preSort = null;
      let preWhere = null;
      let orderPart = null;
      let wherePart = null;
      let originList = [];
      let departureTimes = [];
      let minPriceList = [];
      let isFilteredByDate = false;
      async function manipulation(args) {
        const minPrice = args.context.tryToGetSource("demo.filter-minPrice");
        const maxPrice = args.context.tryToGetSource("demo.filter-maxPrice");
        args.source._rows = args.source._rows.map((el) => (
           el.FlightProposals.map((element) => {
            if (
              !element.FlightGroup ||
              !Array.isArray(element.FlightGroup) ||
              !element.FlightGroup[0]
            ) {
              return element;
            }
            let result = {
              ...element.FlightGroup[0],
              RoutesInfo: element.FlightGroup[0].RoutesInfo
                ? getDicToHtml(element.FlightGroup[0].RoutesInfo)
                : null,
              TotalPrice: element.PriceInfo.Total,
              Currency: element.PriceInfo.Currency,
              ID: element.FlightId,
              PriceInfo: element.PriceInfo
                ? getDicToHtml([element.PriceInfo])
                : null,
              Baggages: element.Baggages
                ? getDicToHtml(element.Baggages)
                : null,
            };
            console.log("moz", result);
            const findTimeZoneIndex = departureTimes.findIndex((element) => {
              return element.zone == findTime(result.DepartureTime);
            });
            if (findTimeZoneIndex == -1) {
              departureTimes.push({ zone: findTime(result.DepartureTime) });
              $bc.setSource("db.timeZone", departureTimes);
            }
            const index = originList.findIndex((element) => {
              return element.Origin == result.Origin;
            });

            if (index == -1) {
              originList.push({ Origin: result.Origin });
              $bc.setSource("db.origin", originList);
              minPriceList.push({
                Origin: result.Origin,
                Price: Number(result.TotalPrice),
              });
              $bc.setSource("db.minPrice", minPriceList);
            } else {
              const elementIndex = minPriceList.findIndex((element) => {
                return element.Origin == result.Origin;
              });
              minPriceList[index].Price =
                minPriceList[index].Price > Number(result.TotalPrice)
                  ? Number(result.TotalPrice)
                  : minPriceList[index].Price;
              $bc.setSource("db.minPrice", minPriceList);
            }
            return result;
          })
        )).flat()
        let source = args.source;
        let retVal = source;

        const where = args.context.tryToGetSource("demo.filter-Destination");
        const origin = args.context.tryToGetSource("demo.filter-origin");
        if (where && preWhere !== where) {
          const nameValue = where.rows[0].value;
          wherePart = nameValue
            ? `where Destination like '%${nameValue}%'`
            : "";
        }
        if (origin && preWhere !== origin) {
          const nameValue = origin.rows[0].value;
          wherePart = nameValue ? `where Origin like '%${nameValue}%'` : "";
        }
        const sort = args.context.tryToGetSource("demo.sort-by");

        if (sort && preSort !== sort) {
          const sortCol = sort.rows[0].value;
          let sortType = "asc";
          if (preSort?.rows[0].value == sortCol) {
            sortType = "desc";
            preSort = null;
          }
          preSort = sort;

          orderPart = `order by ${sortCol} ${sortType}`;
        }
        const sql = `select * from ? ${wherePart ?? ""} ${orderPart ?? ""}`;
        $bc.setSource("demo.sql", sql);
        retVal = await $bc.util.source.runSqlAsync(source, sql, args.context);
        if (companyNames.length > 0) {
          const conditions = companyNames
            .map((companyName) => `Origin = '${companyName}'`)
            .join(" OR ");
          const query = `SELECT * FROM ? WHERE ${conditions}`;
          retVal = await $bc.util.source.runSqlAsync(
            source,
            query,
            args.context
          );
        }
        if (timeZones.length > 0) {
          retVal._rows = retVal._rows.filter((row) => {
            const hour = Number(row.DepartureTime.split(":")[0]);
            if (timeZones.includes("midNight")) {
              if (hour < 6) {
                return true;
              }
            }
            if (timeZones.includes("Night")) {
              if (hour > 18) {
                return true;
              }
            }
            if (timeZones.includes("Noon")) {
              if (hour > 12 && hour >= 18) {
                return true;
              }
            }
            if (timeZones.includes("Day")) {
              if (hour >= 6 && hour <= 12) {
                return true;
              }
            }
            return false;
          });
        }
        retVal._rows = retVal._rows.filter((element) => {
          if (minPrice !== undefined) {
            const minPriceValue = minPrice.rows[0].value;
            if (
              Number(maxPriceValue) != 0 &&
              Number(element.TotalPrice) < Number(minPriceValue)
            ) {
              return false;
            }
          }
          if (maxPrice !== undefined) {
            const maxPriceValue = maxPrice.rows[0].value;
            console.log(Number(element.TotalPrice), Number(maxPriceValue));
            if (
              Number(maxPriceValue) != 0 &&
              Number(element.TotalPrice) > Number(maxPriceValue)
            ) {
              return false;
            }
          }
          return true;
        });
        args.source = retVal;
      }
      function findByCompany(newcompanyName) {
        const index = companyNames.indexOf(newcompanyName);
        if (index !== -1) {
          companyNames.splice(index, 1);
        } else {
          companyNames.push(newcompanyName);
        }
      }
      function findByTimeZone(newTimeZone) {
        const index = timeZones.indexOf(newTimeZone);
        if (index !== -1) {
          timeZones.splice(index, 1);
        } else {
          timeZones.push(newTimeZone);
        }
      }
    </script>
  </body>
</html>
